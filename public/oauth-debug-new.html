<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth æµç¨‹è°ƒè¯• - VisualForge AI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .oauth-button {
            display: block;
            width: 100%;
            padding: 15px;
            background: #4285f4;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            margin: 10px 0;
            transition: background 0.3s;
            border: none;
            cursor: pointer;
        }
        .oauth-button:hover {
            background: #357ae8;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #218838;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .url-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: rgba(40, 167, 69, 0.3);
        }
        .status.error {
            background: rgba(220, 53, 69, 0.3);
        }
        .status.info {
            background: rgba(23, 162, 184, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” OAuth æµç¨‹å®Œæ•´è°ƒè¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ å½“å‰é…ç½®</h3>
            <div class="url-display">
                <strong>Client ID:</strong> 1003903920498-8v900k6gcd6nbtmkn8n0u105b5gposk8.apps.googleusercontent.com<br>
                <strong>å›è°ƒåœ°å€:</strong> https://lbszbktvnuvn.sealoshzh.site/api/auth/google/callback<br>
                <strong>æƒé™èŒƒå›´:</strong> openid email profile<br>
                <strong>å½“å‰åŸŸå:</strong> <span id="currentDomain"></span>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª OAuth æµ‹è¯•æ–¹æ³•</h3>
            
            <!-- æ–¹æ³•1: åç«¯è·¯ç”± -->
            <button onclick="testBackendRoute()" class="oauth-button">
                ğŸ“± æ–¹æ³•1: æµ‹è¯•åç«¯OAuthè·¯ç”±
            </button>
            
            <!-- æ–¹æ³•2: ç›´æ¥Google URL -->
            <button onclick="testDirectGoogle()" class="oauth-button success">
                ğŸ”— æ–¹æ³•2: ç›´æ¥Google OAuth URL
            </button>
            
            <!-- æ–¹æ³•3: æ–°çª—å£æµ‹è¯• -->
            <button onclick="testNewWindow()" class="oauth-button">
                ğŸªŸ æ–¹æ³•3: æ–°çª—å£æµ‹è¯•
            </button>
            
            <!-- å±é™©æµ‹è¯•: ç›´æ¥è®¿é—®å›è°ƒ -->
            <button onclick="testCallbackDirect()" class="oauth-button danger">
                âš ï¸ å±é™©æµ‹è¯•: ç›´æ¥è®¿é—®å›è°ƒURL (ä¼šå‡ºé”™)
            </button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•æ—¥å¿—</h3>
            <div id="log" class="log">
                ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...<br>
            </div>
            <button onclick="clearLog()" class="oauth-button" style="background: #6c757d;">
                ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
            </button>
        </div>

        <div class="test-section">
            <h3>ğŸ” URL åˆ†æ</h3>
            <div id="urlAnalysis" class="log">
                ç­‰å¾…ç”ŸæˆOAuth URL...
            </div>
        </div>

        <div id="status" class="status info">
            <h4>ğŸ“ˆ å½“å‰çŠ¶æ€</h4>
            <p>å‡†å¤‡å¼€å§‹OAuthæµ‹è¯•ã€‚è¯·é€‰æ‹©ä¸Šæ–¹çš„æµ‹è¯•æ–¹æ³•ã€‚</p>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰åŸŸå
        document.getElementById('currentDomain').textContent = window.location.origin;

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º<br>';
        }

        function setStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.className = `status ${type}`;
            statusElement.innerHTML = `<h4>ğŸ“ˆ ${type === 'success' ? 'æˆåŠŸ' : type === 'error' ? 'é”™è¯¯' : 'çŠ¶æ€'}</h4><p>${message}</p>`;
        }

        // ç”Ÿæˆå¹¶åˆ†æOAuth URL
        function generateOAuthURL() {
            const GOOGLE_CLIENT_ID = '1003903920498-8v900k6gcd6nbtmkn8n0u105b5gposk8.apps.googleusercontent.com';
            const GOOGLE_REDIRECT_URI = 'https://lbszbktvnuvn.sealoshzh.site/api/auth/google/callback';
            
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${encodeURIComponent(GOOGLE_CLIENT_ID)}&` +
                `redirect_uri=${encodeURIComponent(GOOGLE_REDIRECT_URI)}&` +
                `scope=${encodeURIComponent('openid email profile')}&` +
                `response_type=code&` +
                `access_type=offline&` +
                `prompt=consent`;
            
            // æ˜¾ç¤ºURLåˆ†æ
            document.getElementById('urlAnalysis').innerHTML = `
                <strong>ç”Ÿæˆçš„OAuth URL:</strong><br>
                ${authUrl}<br><br>
                <strong>å‚æ•°åˆ†æ:</strong><br>
                â€¢ client_id: ${GOOGLE_CLIENT_ID}<br>
                â€¢ redirect_uri: ${GOOGLE_REDIRECT_URI}<br>
                â€¢ scope: openid email profile<br>
                â€¢ response_type: code<br>
                â€¢ access_type: offline<br>
                â€¢ prompt: consent
            `;
            
            return authUrl;
        }

        // æµ‹è¯•æ–¹æ³•1: åç«¯è·¯ç”±
        function testBackendRoute() {
            log('ğŸš€ å¼€å§‹æµ‹è¯•åç«¯OAuthè·¯ç”±');
            setStatus('æ­£åœ¨æµ‹è¯•åç«¯OAuthè·¯ç”±...', 'info');
            
            const backendUrl = 'https://lbszbktvnuvn.sealoshzh.site/api/auth/google';
            log(`è®¿é—®åç«¯è·¯ç”±: ${backendUrl}`);
            
            window.location.href = backendUrl;
        }

        // æµ‹è¯•æ–¹æ³•2: ç›´æ¥Google OAuth
        function testDirectGoogle() {
            log('ğŸ”— å¼€å§‹æµ‹è¯•ç›´æ¥Google OAuth');
            setStatus('æ­£åœ¨ç”Ÿæˆç›´æ¥OAuth URL...', 'info');
            
            const authUrl = generateOAuthURL();
            log(`ç”Ÿæˆçš„OAuth URL: ${authUrl.substring(0, 100)}...`);
            log('æ­£åœ¨è·³è½¬åˆ°Googleè®¤è¯é¡µé¢...');
            
            window.location.href = authUrl;
        }

        // æµ‹è¯•æ–¹æ³•3: æ–°çª—å£
        function testNewWindow() {
            log('ğŸªŸ å¼€å§‹æ–°çª—å£æµ‹è¯•');
            setStatus('æ­£åœ¨æ–°çª—å£ä¸­æ‰“å¼€OAuth...', 'info');
            
            const authUrl = generateOAuthURL();
            const newWindow = window.open(authUrl, 'oauth', 'width=600,height=700');
            
            log('å·²åœ¨æ–°çª—å£ä¸­æ‰“å¼€OAuthè®¤è¯');
            log('è¯·åœ¨æ–°çª—å£ä¸­å®Œæˆè®¤è¯ï¼Œç„¶åæŸ¥çœ‹ç»“æœ');
            
            // ç›‘å¬æ–°çª—å£å…³é—­
            const checkClosed = setInterval(() => {
                if (newWindow.closed) {
                    clearInterval(checkClosed);
                    log('æ–°çª—å£å·²å…³é—­');
                    setStatus('æ–°çª—å£å·²å…³é—­ï¼Œè¯·æ£€æŸ¥è®¤è¯ç»“æœ', 'info');
                }
            }, 1000);
        }

        // å±é™©æµ‹è¯•: ç›´æ¥è®¿é—®å›è°ƒ
        function testCallbackDirect() {
            log('âš ï¸ å±é™©æµ‹è¯•: ç›´æ¥è®¿é—®å›è°ƒURL');
            setStatus('è­¦å‘Šï¼šè¿™å°†å¯¼è‡´é”™è¯¯ï¼Œä»…ç”¨äºéªŒè¯é”™è¯¯å¤„ç†', 'error');
            
            const callbackUrl = 'https://lbszbktvnuvn.sealoshzh.site/api/auth/google/callback';
            log(`ç›´æ¥è®¿é—®: ${callbackUrl}`);
            log('é¢„æœŸç»“æœ: åº”è¯¥æ˜¾ç¤º "Missing required parameter: scope" é”™è¯¯');
            
            window.open(callbackUrl, '_blank');
        }

        // æ£€æŸ¥URLå‚æ•°
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const authResult = urlParams.get('auth');
            const error = urlParams.get('error');
            const token = urlParams.get('token');
            const code = urlParams.get('code');

            if (authResult === 'success') {
                log('âœ… OAuthè®¤è¯æˆåŠŸï¼');
                setStatus('OAuthè®¤è¯æˆåŠŸå®Œæˆï¼', 'success');
                if (token) {
                    log(`è·å¾—Token: ${token.substring(0, 20)}...`);
                }
            } else if (error) {
                log(`âŒ OAuthè®¤è¯å¤±è´¥: ${error}`);
                setStatus(`OAuthè®¤è¯å¤±è´¥: ${error}`, 'error');
            } else if (code) {
                log(`ğŸ“ è·å¾—æˆæƒç : ${code.substring(0, 20)}...`);
                setStatus('è·å¾—æˆæƒç ï¼Œç­‰å¾…åç«¯å¤„ç†...', 'info');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            generateOAuthURL();
            checkUrlParams();
        });
    </script>
</body>
</html> 