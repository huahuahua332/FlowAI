# 🚀 AI视频生成平台前端开发集成指南

## 📋 项目概述

### 基础信息
- **API基础地址**: `https://lbszbktvnuvn.sealoshzh.site`
- **API版本**: 1.0.0
- **认证方式**: JWT Token + Google OAuth
- **Content-Type**: `application/json`
- **响应格式**: JSON
- **支付系统**: Creem 集成
- **数据库**: MongoDB (生产环境)

### 支持的AI视频生成模型
| 模型ID | 模型名称 | 功能 | 分辨率 | 时长 | 订阅要求 | 积分消耗(5s/10s) |
|--------|----------|------|--------|------|----------|------------------|
| `wan-i2v` | WAN I2V | 图片转视频 | 480p | 5-10秒 | 免费版+ | 22/32积分 |
| `wan-t2v` | WAN T2V | 文本转视频 | 720p | 5-10秒 | Plus版+ | 45/65积分 |
| `veo-3` | Google Veo-3 | 高质量文本转视频 | 1080p | 5-10秒 | 旗舰版 | 70/140积分 |

## 🔐 认证系统

### 1. Google OAuth 登录流程

#### 方法1: 直接跳转登录
```javascript
function loginWithGoogle() {
    window.location.href = 'https://lbszbktvnuvn.sealoshzh.site/api/auth/google';
}
```

#### 方法2: 弹窗登录（推荐）
```javascript
function loginWithGooglePopup() {
    const popup = window.open(
        'https://lbszbktvnuvn.sealoshzh.site/api/auth/google',
        'google-login',
        'width=500,height=600,scrollbars=yes,resizable=yes'
    );
    
    window.addEventListener('message', (event) => {
        if (event.origin !== 'https://lbszbktvnuvn.sealoshzh.site') return;
        
        if (event.data.token) {
            localStorage.setItem('authToken', event.data.token);
            popup.close();
            handleLoginSuccess(event.data.token);
        }
    });
}
```

### 2. OAuth回调处理
```javascript
// 在 /auth/callback 页面处理token
function handleOAuthCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const userInfo = JSON.parse(decodeURIComponent(urlParams.get('user') || '{}'));
    const success = urlParams.get('success') === 'true';

    if (success && token) {
        localStorage.setItem('authToken', token);
        localStorage.setItem('user', JSON.stringify(userInfo));
        
        // 如果是弹窗登录，向父窗口发送消息
        if (window.opener) {
            window.opener.postMessage({ token, user: userInfo }, 'https://lbszbktvnuvn.sealoshzh.site');
            window.close();
            return;
        }
        
        // 直接跳转登录，重定向到主页
        window.location.href = '/dashboard';
    } else {
        console.error('OAuth登录失败');
        window.location.href = '/login?error=oauth_failed';
    }
}
```

### 3. 认证API端点

#### 获取当前用户信息
```javascript
// GET /api/auth/me
async function getCurrentUser() {
    const token = localStorage.getItem('authToken');
    if (!token) throw new Error('未找到认证token');
    
    const response = await fetch('https://lbszbktvnuvn.sealoshzh.site/api/auth/me', {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });
    
    const data = await response.json();
    if (data.success) {
        return data.data.user;
    } else {
        throw new Error(data.message);
    }
}

// 响应数据结构
{
  "success": true,
  "data": {
    "user": {
      "_id": "user_id",
      "name": "用户名",
      "email": "user@example.com",
      "avatar": "头像URL",
      "subscriptionLevel": "free", // 'free' | 'plus' | 'pro' | 'flagship'
      "points": 120,
      "lastSigninDate": "2024-01-15T00:00:00.000Z",
      "consecutiveSigninDays": 5,
      "monthlySigninDays": 15,
      "subscriptionExpiry": "2024-02-15T00:00:00.000Z",
      "isSubscriptionActive": true,
      "effectiveLevel": "plus",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  }
}
```

#### 用户登出
```javascript
// POST /api/auth/logout
async function logout() {
    const token = localStorage.getItem('authToken');
    
    try {
        await fetch('https://lbszbktvnuvn.sealoshzh.site/api/auth/logout', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
    } catch (error) {
        console.error('登出请求失败:', error);
    } finally {
        localStorage.removeItem('authToken');
        localStorage.removeItem('user');
        window.location.href = '/login';
    }
}
```

## 🎬 视频生成API

### 1. 统一视频生成端点（推荐使用）

```javascript
// POST /api/generate/video
async function generateVideo(params) {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('https://lbszbktvnuvn.sealoshzh.site/api/generate/video', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(params)
    });
    
    return await response.json();
}
```

### 2. 不同模型的请求参数

#### 文本转视频 (wan-t2v)
```javascript
const params = {
    model: 'wan-t2v',
    prompt: '一只可爱的小猫在花园里玩耍',
    duration: 5, // 5 或 10 秒
    batchSize: 1 // 1-4个视频
};
```

#### 图片转视频 (wan-i2v)
```javascript
const params = {
    model: 'wan-i2v',
    prompt: '让这张图片动起来',
    image: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABA...', // base64图片数据
    duration: 5,
    batchSize: 1
};
```

#### 高质量生成 (veo-3)
```javascript
const params = {
    model: 'veo-3',
    prompt: '科幻城市的未来景象，霓虹灯闪烁',
    duration: 10,
    batchSize: 2
};
```

### 3. 响应数据结构
```javascript
// 成功响应
{
    "success": true,
    "data": {
        "videoIds": ["video_id_1", "video_id_2"],
        "batchSize": 2,
        "status": "processing",
        "message": "批量生成请求已提交，正在生成 2 个视频，请稍后查看结果",
        "model": "veo-3",
        "pointsUsed": 140
    }
}

// 错误响应
{
    "success": false,
    "message": "积分不足，批量生成2个视频需要 140 积分，当前积分: 100",
    "code": "INSUFFICIENT_POINTS"
}
```

### 4. 查询视频生成状态
```javascript
// GET /api/generate/status/:videoId
async function getVideoStatus(videoId) {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`https://lbszbktvnuvn.sealoshzh.site/api/generate/status/${videoId}`, {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    
    return await response.json();
}

// 响应示例
{
    "success": true,
    "data": {
        "videoId": "video_id_1",
        "status": "completed", // 'pending' | 'processing' | 'completed' | 'failed'
        "videoUrl": "https://example.com/video.mp4",
        "thumbnailUrl": "https://example.com/thumb.jpg",
        "progress": 100,
        "model": "wan-t2v",
        "prompt": "一只可爱的小猫在花园里玩耍",
        "duration": 5,
        "pointsUsed": 45,
        "createdAt": "2024-01-01T12:00:00Z",
        "completedAt": "2024-01-01T12:05:00Z"
    }
}
```

### 5. 获取视频生成历史
```javascript
// GET /api/generate/history?page=1&limit=10
async function getVideoHistory(page = 1, limit = 10) {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`https://lbszbktvnuvn.sealoshzh.site/api/generate/history?page=${page}&limit=${limit}`, {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    
    return await response.json();
}

// 响应示例
{
    "success": true,
    "data": {
        "videos": [
            {
                "videoId": "video_id_1",
                "status": "completed",
                "videoUrl": "https://example.com/video.mp4",
                "thumbnailUrl": "https://example.com/thumb.jpg",
                "model": "wan-t2v",
                "prompt": "一只可爱的小猫在花园里玩耍",
                "duration": 5,
                "pointsUsed": 45,
                "createdAt": "2024-01-01T12:00:00Z"
            }
        ],
        "pagination": {
            "page": 1,
            "limit": 10,
            "total": 25,
            "pages": 3,
            "hasNext": true,
            "hasPrev": false
        }
    }
}
```

## 👤 用户管理API

### 1. 每日签到系统

#### 执行签到
```javascript
// POST /api/user/signin
async function dailySignin() {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('https://lbszbktvnuvn.sealoshzh.site/api/user/signin', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });
    
    return await response.json();
}

// 响应示例
{
    "success": true,
    "data": {
        "pointsEarned": 7, // 基础2积分 + 连续奖励5积分
        "consecutiveDays": 7,
        "monthlyDays": 15,
        "totalPoints": 127,
        "bonusMessage": "连续7天奖励 5 积分！",
        "message": "签到成功！获得 7 积分"
    }
}
```

#### 获取签到状态
```javascript
// GET /api/user/signin-status
async function getSigninStatus() {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('https://lbszbktvnuvn.sealoshzh.site/api/user/signin-status', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    
    return await response.json();
}

// 响应示例
{
    "success": true,
    "data": {
        "hasSignedToday": false,
        "consecutiveDays": 6,
        "monthlyDays": 14,
        "lastSigninDate": "2024-01-14T12:00:00Z",
        "nextWeeklyReward": 1, // 距离下次7天奖励还需要1天
        "nextMonthlyReward": 11, // 距离下次25天奖励还需要11天
        "rewards": {
            "daily": 2,
            "weekly": 5, // 连续7天奖励
            "monthly": 12 // 连续25天奖励
        }
    }
}
```

### 2. 用户统计信息
```javascript
// GET /api/user/stats
async function getUserStats() {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('https://lbszbktvnuvn.sealoshzh.site/api/user/stats', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    
    return await response.json();
}

// 响应示例
{
    "success": true,
    "data": {
        "user": {
            "id": "user_id",
            "name": "用户名",
            "email": "user@example.com",
            "avatar": "头像URL",
            "points": 150,
            "subscriptionLevel": "plus",
            "effectiveLevel": "plus",
            "subscriptionExpiry": "2024-02-15T00:00:00Z",
            "isSubscriptionActive": true
        },
        "stats": {
            "todayGenerations": 3,
            "totalGenerations": 25,
            "monthlyPointsUsed": 180,
            "consecutiveSigninDays": 6
        },
        "limits": {
            "monthlyGenerations": -1, // -1表示无限制
            "maxDuration": 5,
            "allowedModels": ["wan-i2v", "wan-t2v"],
            "maxResolution": "720p",
            "batchSize": 1,
            "monthlyPoints": 120
        }
    }
}
```

### 3. 积分历史记录
```javascript
// GET /api/user/points-history?page=1&limit=20
async function getPointsHistory(page = 1, limit = 20) {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`https://lbszbktvnuvn.sealoshzh.site/api/user/points-history?page=${page}&limit=${limit}`, {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    
    return await response.json();
}

// 响应示例
{
    "success": true,
    "data": {
        "history": [
            {
                "type": "video_generation",
                "points": -45,
                "description": "WAN T2V 5秒视频生成",
                "videoId": "video_123",
                "createdAt": "2024-01-15T10:00:00.000Z"
            },
            {
                "type": "daily_signin",
                "points": 2,
                "description": "每日签到奖励",
                "createdAt": "2024-01-15T09:00:00.000Z"
            },
            {
                "type": "subscription_reward",
                "points": 120,
                "description": "Plus版订阅奖励",
                "createdAt": "2024-01-01T00:00:00.000Z"
            }
        ],
        "pagination": {
            "current": 1,
            "total": 10,
            "count": 200,
            "hasNext": true,
            "hasPrev": false
        }
    }
}
```

## 💳 支付系统API

### 1. 订阅计划

#### 订阅等级对比表
| 等级 | 月费 | 年费 | 月度积分 | 可用模型 | 最大时长 | 批量生成 | 最高分辨率 |
|------|------|------|----------|----------|----------|----------|------------|
| 免费版 | $0 | - | 30 | WAN I2V | 5秒 | 1个 | 480P |
| Plus版 | $12.99 | $9.99 | 120/1440 | I2V + T2V | 5秒 | 1个 | 720P |
| Pro版 | $36.99 | $29.99 | 380/4560 | I2V + T2V | 5-10秒 | 4个 | 720P |
| 旗舰版 | $99.99 | $69.99 | 1000/12000 | 全部模型 | 5-10秒 | 4个 | 1080P |

#### 获取订阅计划
```javascript
// GET /api/payment/plans
async function getSubscriptionPlans() {
    const response = await fetch('https://lbszbktvnuvn.sealoshzh.site/api/payment/plans');
    return await response.json();
}
```

#### 创建订阅支付
```javascript
// POST /api/payment/create-subscription
async function createSubscriptionPayment(planId) {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('https://lbszbktvnuvn.sealoshzh.site/api/payment/create-subscription', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            plan_id: planId
        })
    });
    
    const result = await response.json();
    
    if (result.success) {
        // 重定向到支付页面
        window.location.href = result.data.checkout_url;
    }
    
    return result;
}
```

### 2. 积分充值包

#### 积分包价格表
| 积分数量 | 价格 | 赠送积分 | 总积分 | 推荐 |
|----------|------|----------|--------|------|
| 100 | $9.99 | 10 | 110 | - |
| 250 | $22.99 | 25 | 275 | ⭐ |
| 500 | $44.99 | 50 | 550 | - |
| 1000 | $79.99 | 100 | 1100 | 💎 |

#### 获取积分充值包
```javascript
// GET /api/payment/points-packages
async function getPointsPackages() {
    const response = await fetch('https://lbszbktvnuvn.sealoshzh.site/api/payment/points-packages');
    return await response.json();
}
```

#### 创建积分充值支付
```javascript
// POST /api/payment/create-points-payment
async function createPointsPayment(planId) {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch('https://lbszbktvnuvn.sealoshzh.site/api/payment/create-points-payment', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            plan_id: planId
        })
    });
    
    const result = await response.json();
    
    if (result.success) {
        window.location.href = result.data.checkout_url;
    }
    
    return result;
}
```

## 🛠️ 前端集成工具函数

### 1. API请求封装
```javascript
class APIClient {
    constructor(baseURL = 'https://lbszbktvnuvn.sealoshzh.site') {
        this.baseURL = baseURL;
    }
    
    getToken() {
        return localStorage.getItem('authToken');
    }
    
    async request(endpoint, options = {}) {
        const token = this.getToken();
        
        const config = {
            headers: {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` }),
                ...options.headers
            },
            ...options
        };
        
        const response = await fetch(`${this.baseURL}${endpoint}`, config);
        
        // 处理401错误
        if (response.status === 401) {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = '/login';
            return;
        }
        
        return await response.json();
    }
    
    // GET请求
    async get(endpoint) {
        return this.request(endpoint);
    }
    
    // POST请求
    async post(endpoint, data) {
        return this.request(endpoint, {
            method: 'POST',
            body: JSON.stringify(data)
        });
    }
}

// 使用示例
const api = new APIClient();

// 获取用户信息
const user = await api.get('/api/auth/me');

// 生成视频
const result = await api.post('/api/generate/video', {
    model: 'wan-t2v',
    prompt: '一只可爱的小猫',
    duration: 5
});
```

### 2. 权限检查函数
```javascript
// 检查用户权限
function checkUserPermissions(user, selectedModel, duration, batchSize) {
    const limits = {
        free: {
            allowedModels: ['wan-i2v'],
            maxDuration: 5,
            batchSize: 1
        },
        plus: {
            allowedModels: ['wan-i2v', 'wan-t2v'],
            maxDuration: 5,
            batchSize: 1
        },
        pro: {
            allowedModels: ['wan-i2v', 'wan-t2v'],
            maxDuration: 10,
            batchSize: 4
        },
        flagship: {
            allowedModels: ['wan-i2v', 'wan-t2v', 'veo-3'],
            maxDuration: 10,
            batchSize: 4
        }
    };

    const userLimits = limits[user.subscriptionLevel] || limits.free;
    
    return {
        modelAllowed: userLimits.allowedModels.includes(selectedModel),
        durationAllowed: duration <= userLimits.maxDuration,
        batchSizeAllowed: batchSize <= userLimits.batchSize,
        needsUpgrade: !userLimits.allowedModels.includes(selectedModel)
    };
}
```

### 3. 积分计算函数
```javascript
// 计算积分消耗
function calculatePoints(model, duration, batchSize = 1) {
    const pointsTable = {
        'wan-i2v': { 5: 22, 10: 32 },
        'wan-t2v': { 5: 45, 10: 65 },
        'veo-3': { 5: 70, 10: 140 }
    };
    
    const singlePoints = pointsTable[model][duration];
    return singlePoints * batchSize;
}

// 检查积分是否足够
function checkSufficientPoints(userPoints, model, duration, batchSize) {
    const requiredPoints = calculatePoints(model, duration, batchSize);
    return {
        sufficient: userPoints >= requiredPoints,
        required: requiredPoints,
        current: userPoints,
        shortage: Math.max(0, requiredPoints - userPoints)
    };
}
```

### 4. 视频状态轮询
```javascript
// 轮询视频生成状态
function pollVideoStatus(videoId, callback, interval = 3000) {
    const api = new APIClient();
    
    const poll = async () => {
        try {
            const response = await api.get(`/api/generate/status/${videoId}`);
            
            if (response.success) {
                const video = response.data;
                callback(video);
                
                if (video.status === 'processing') {
                    setTimeout(poll, interval);
                } else {
                    // 生成完成或失败
                    return;
                }
            }
        } catch (error) {
            console.error('查询视频状态失败:', error);
            setTimeout(poll, interval * 2); // 错误时延长间隔
        }
    };
    
    poll();
}

// 使用示例
pollVideoStatus('video_123', (video) => {
    console.log('视频状态更新:', video.status);
    
    if (video.status === 'completed') {
        console.log('视频生成完成:', video.videoUrl);
    } else if (video.status === 'failed') {
        console.log('视频生成失败:', video.error);
    }
});
```

## 📱 React Hook 示例

### useAuth Hook
```javascript
import { useState, useEffect } from 'react';

export const useAuth = () => {
    const [user, setUser] = useState(null);
    const [token, setToken] = useState(localStorage.getItem('authToken'));
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (token) {
            fetchUserInfo();
        } else {
            setLoading(false);
        }
    }, [token]);

    const fetchUserInfo = async () => {
        try {
            const api = new APIClient();
            const response = await api.get('/api/auth/me');
            
            if (response.success) {
                setUser(response.data.user);
            } else {
                logout();
            }
        } catch (error) {
            console.error('获取用户信息失败:', error);
            logout();
        } finally {
            setLoading(false);
        }
    };

    const login = () => {
        window.location.href = 'https://lbszbktvnuvn.sealoshzh.site/api/auth/google';
    };

    const logout = () => {
        localStorage.removeItem('authToken');
        localStorage.removeItem('user');
        setUser(null);
        setToken(null);
    };

    return { user, token, loading, login, logout, fetchUserInfo };
};
```

### useVideoGeneration Hook
```javascript
import { useState } from 'react';

export const useVideoGeneration = () => {
    const [loading, setLoading] = useState(false);
    const [videos, setVideos] = useState([]);

    const generateVideo = async (params) => {
        setLoading(true);
        
        try {
            const api = new APIClient();
            const response = await api.post('/api/generate/video', params);

            if (response.success) {
                const newVideos = response.data.videoIds.map(id => ({
                    id,
                    status: 'processing',
                    model: params.model,
                    prompt: params.prompt,
                    createdAt: new Date().toISOString()
                }));
                
                setVideos(prev => [...newVideos, ...prev]);
                
                // 开始轮询状态
                newVideos.forEach(video => {
                    pollVideoStatus(video.id, (updatedVideo) => {
                        setVideos(prev => prev.map(v => 
                            v.id === video.id ? { ...v, ...updatedVideo } : v
                        ));
                    });
                });
                
                return response;
            } else {
                throw new Error(response.message);
            }
        } catch (error) {
            console.error('视频生成失败:', error);
            throw error;
        } finally {
            setLoading(false);
        }
    };

    return { loading, videos, generateVideo };
};
```

## 🔒 安全注意事项

1. **Token 存储**: 使用 `localStorage` 存储 JWT Token
2. **HTTPS**: 生产环境必须使用 HTTPS
3. **CORS**: 后端已配置 CORS，支持跨域请求
4. **内容审核**: 所有提示词会经过 OpenAI 内容审核
5. **速率限制**: API 有速率限制，注意处理 429 错误
6. **文件上传**: 图片需要转换为 base64 格式上传

## 📞 技术支持

- **服务器状态**: https://lbszbktvnuvn.sealoshzh.site/health
- **API文档**: 本文档
- **错误日志**: 查看浏览器控制台和网络请求

---

**文档版本**: 1.0.0  
**最后更新**: 2024年6月19日  
**服务状态**: 🟢 正常运行  
**维护者**: 后端开发团队 