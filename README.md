# è§†é¢‘ç”Ÿæˆåç«¯æœåŠ¡

åŸºäº Node.js + Express + MongoDB + Mongoose æ„å»ºçš„è§†é¢‘ç”Ÿæˆåç«¯æœåŠ¡ï¼Œé›†æˆ Google OAuth ç™»å½•ã€Creem æ”¯ä»˜ç³»ç»Ÿï¼Œä»¥åŠå¤šç§AIè§†é¢‘ç”Ÿæˆæ¨¡å‹ï¼šGoogle Veo-3ã€WAN I2V å’Œ WAN T2Vã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” ç”¨æˆ·ç³»ç»Ÿ
- Google OAuth ç™»å½•é›†æˆ
- JWT ä»¤ç‰Œè®¤è¯
- ç”¨æˆ·èµ„æ–™ç®¡ç†
- è®¢é˜…ç­‰çº§ç®¡ç†

### ğŸ’³ æ”¯ä»˜ç³»ç»Ÿ
- **Creem æ”¯ä»˜é›†æˆ**: å®Œæ•´çš„æ”¯ä»˜æµç¨‹å’Œè®¢é˜…ç®¡ç†
- **è®¢é˜…ç®¡ç†**: å…è´¹ç‰ˆã€Plusç‰ˆã€Proç‰ˆã€æ——èˆ°ç‰ˆå››ä¸ªç­‰çº§
- **ç§¯åˆ†å……å€¼**: 100/250/500/1000ç§¯åˆ†å……å€¼åŒ…ï¼Œå«èµ é€ç§¯åˆ†
- **Webhook å¤„ç†**: å®æ—¶åŒæ­¥æ”¯ä»˜çŠ¶æ€å’Œè®¢é˜…å˜æ›´
- **å®‰å…¨éªŒè¯**: å®Œæ•´çš„ç­¾åéªŒè¯å’ŒHTTPSåŠ å¯†

### ğŸ¬ è§†é¢‘ç”Ÿæˆ

- **Google Veo-3**: é«˜è´¨é‡æ–‡æœ¬è½¬è§†é¢‘ï¼ˆä»˜è´¹ç”¨æˆ·ä¸“äº«ï¼‰
- **WAN I2V**: å›¾ç‰‡è½¬è§†é¢‘ç”Ÿæˆï¼ˆä»˜è´¹ç”¨æˆ·ä¸“äº«ï¼‰
- **WAN T2V**: æ–‡æœ¬è½¬720pè§†é¢‘ï¼ˆä»˜è´¹ç”¨æˆ·ä¸“äº«ï¼‰
- æ”¯æŒå›¾ç‰‡è¾“å…¥ã€å‚è€ƒå›¾ç‰‡ã€é£æ ¼è®¾ç½®
- è‡ªåŠ¨ç”Ÿæˆè‹±æ–‡æ ‡é¢˜å’Œå°é¢

### ğŸ¯ ç§¯åˆ†ä¸é™åˆ¶
- åŸºäºè®¢é˜…ç­‰çº§çš„ä½¿ç”¨é™åˆ¶
- æ™ºèƒ½ç§¯åˆ†æ‰£é™¤ç³»ç»Ÿ
- æ¯æ—¥ç”Ÿæˆæ¬¡æ•°é™åˆ¶
- å¤±è´¥è‡ªåŠ¨é€€æ¬¾

### âœ… æ¯æ—¥ç­¾åˆ°
- æ¯æ—¥ç­¾åˆ°å¥–åŠ±ç§¯åˆ†
- è¿ç»­ç­¾åˆ°7å¤©é¢å¤–å¥–åŠ±
- ç­¾åˆ°çŠ¶æ€è·Ÿè¸ª

### ğŸ”¥ çƒ­é—¨æ¨è
- è‡ªåŠ¨ç»Ÿè®¡çƒ­é—¨æç¤ºè¯
- å®šæ—¶ä»»åŠ¡æ›´æ–°æ’è¡Œæ¦œ
- æç¤ºè¯æœç´¢å’Œåˆ†ç±»

### ğŸ¤– AI å¢å¼º
- GPT-4 Turbo è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜
- æç¤ºè¯ä¼˜åŒ–å»ºè®®
- å†…å®¹å®‰å…¨æ£€æŸ¥

## æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: Node.js + Express
- **æ•°æ®åº“**: MongoDB + Mongoose
- **è®¤è¯**: Passport.js + Google OAuth 2.0
- **æ”¯ä»˜**: Creem Payment API
- **AI æœåŠ¡**: OpenAI GPT-4 Turbo
- **å­˜å‚¨**: é˜¿é‡Œäº‘ OSS
- **å®šæ—¶ä»»åŠ¡**: node-cron
- **å®‰å…¨**: Helmet + CORS + Rate Limiting

## é¡¹ç›®ç»“æ„

```
â”œâ”€â”€ config/
â”‚   â””â”€â”€ database.js          # æ•°æ®åº“è¿æ¥é…ç½®
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ User.js             # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ Video.js            # è§†é¢‘æ¨¡å‹
â”‚   â”œâ”€â”€ HotPrompt.js        # çƒ­é—¨æç¤ºè¯æ¨¡å‹
â”‚   â””â”€â”€ Config.js           # é…ç½®æ¨¡å‹
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth.js             # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ checkPoints.js      # ç§¯åˆ†æ£€æŸ¥ä¸­é—´ä»¶
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ videoService.js     # è§†é¢‘ç”ŸæˆæœåŠ¡
â”‚   â”œâ”€â”€ ossService.js       # OSS å­˜å‚¨æœåŠ¡
â”‚   â””â”€â”€ openaiService.js    # OpenAI æœåŠ¡
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ auth.js             # è®¤è¯è·¯ç”±
â”‚   â”œâ”€â”€ generate.js         # è§†é¢‘ç”Ÿæˆè·¯ç”±
â”‚   â”œâ”€â”€ user.js             # ç”¨æˆ·è·¯ç”±
â”‚   â”œâ”€â”€ payment.js          # æ”¯ä»˜è·¯ç”±
â”‚   â””â”€â”€ prompt.js           # æç¤ºè¯è·¯ç”±
â”œâ”€â”€ jobs/
â”‚   â””â”€â”€ cronJobs.js         # å®šæ—¶ä»»åŠ¡
â”œâ”€â”€ server.js               # ä¸»æœåŠ¡å™¨æ–‡ä»¶
â”œâ”€â”€ package.json            # é¡¹ç›®ä¾èµ–
â””â”€â”€ config.env              # ç¯å¢ƒå˜é‡é…ç½®
```

## å®‰è£…å’Œè¿è¡Œ

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `config.env` æ–‡ä»¶å¹¶å¡«å…¥å®é™…çš„é…ç½®ä¿¡æ¯ï¼š

```bash
# æ•°æ®åº“é…ç½®
MONGODB_URI=mongodb://root:q2lr8xrk@test-db-mongodb.ns-6i6eq5c2.svc:27017
DB_NAME=video_generation

# JWT å¯†é’¥
JWT_SECRET=your_jwt_secret_key_here

# Google OAuth é…ç½®
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_CALLBACK_URL=http://localhost:3000/auth/google/callback

# Creem æ”¯ä»˜é…ç½®
CREEM_API_URL=https://api.creem.io
CREEM_API_KEY=creem_7ArQsO9ktfhrJetYpkngP3
CREEM_WEBHOOK_SECRET=whsec_3xPge4daBeqwUY3sbUgjWv
CREEM_ENVIRONMENT=production

# è®¢é˜…è®¡åˆ’ ID
CREEM_PLAN_PLUS_MONTHLY=prod_5oENOhXvTZ57S68mz48pHj
CREEM_PLAN_PLUS_YEARLY=prod_3XyMq9HBrrPmCrXwpRCKLy
CREEM_PLAN_PRO_MONTHLY=prod_3mizlp40Lysjh1Z4w0SDRK
CREEM_PLAN_PRO_YEARLY=prod_1BWivRIF8lhIt14cTWAAFq
CREEM_PLAN_FLAGSHIP_MONTHLY=prod_4SEvDTteBLeV435uL1C1Yx
CREEM_PLAN_FLAGSHIP_YEARLY=prod_SXu8zIPQqU2bWYIij9uSo

# ç§¯åˆ†å……å€¼è®¡åˆ’ ID
CREEM_POINTS_100=prod_5crVdSzFaypTX6vnIOqZL3
CREEM_POINTS_250=prod_npArLmyY8e7f3oeYSjN24
CREEM_POINTS_500=prod_63gPLhh9ACl58PGp4qyWnr
CREEM_POINTS_1000=prod_60cOBGjJZ28kgwyAzulMuu

# Webhook é…ç½®
WEBHOOK_CALLBACK_URL=https://lbszbktvnuvn.sealoshzh.site/api/payment/webhook
FRONTEND_URL=https://lbszbktvnuvn.sealoshzh.site

# OpenAI é…ç½®
OPENAI_API_KEY=your_openai_api_key

# é˜¿é‡Œäº‘ OSS é…ç½®
OSS_REGION=your_oss_region
OSS_ACCESS_KEY_ID=your_oss_access_key_id
OSS_ACCESS_KEY_SECRET=your_oss_access_key_secret
OSS_BUCKET=your_oss_bucket



# Replicate API é…ç½®
REPLICATE_API_TOKEN=your_replicate_api_token

# AI æ¨¡å‹é…ç½®
VEO_3_MODEL=google/veo-3
WAN_I2V_MODEL=wavespeedai/wan-2.1-i2v-480p
WAN_T2V_MODEL=wavespeedai/wan-2.1-t2v-720p

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=development
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm start
```

## API æ¥å£æ–‡æ¡£

### è®¤è¯æ¥å£

#### Google OAuth ç™»å½•
```
GET /auth/google
```

#### è·å–ç”¨æˆ·ä¿¡æ¯
```
GET /auth/me
Authorization: Bearer <token>
```

### è§†é¢‘ç”Ÿæˆæ¥å£



#### Google Veo-3 è§†é¢‘ç”Ÿæˆ
```
POST /api/generate/veo-3
Authorization: Bearer <token>
Content-Type: application/json

{
  "prompt": "A beautiful sunset over the ocean",
  "duration": 5,
  "aspectRatio": "16:9"
}
```

#### WAN I2V å›¾ç‰‡è½¬è§†é¢‘
```
POST /api/generate/wan-i2v
Authorization: Bearer <token>
Content-Type: application/json

{
  "image": "https://example.com/image.jpg",
  "prompt": "A woman is talking",
  "duration": 4
}
```

#### WAN T2V æ–‡æœ¬è½¬è§†é¢‘
```
POST /api/generate/wan-t2v
Authorization: Bearer <token>
Content-Type: application/json

{
  "prompt": "A beautiful sunset over the ocean",
  "duration": 4
}
```

#### æ‰¹é‡ç”Ÿæˆç¤ºä¾‹ (Pro/æ——èˆ°ç‰ˆ)
```
POST /api/generate/wan-t2v
Authorization: Bearer <token>
Content-Type: application/json

{
  "prompt": "A cat playing with a ball",
  "duration": 5,
  "batchSize": 4,
  "resolution": "720p"
}
```

#### è·å–ç”ŸæˆçŠ¶æ€
```
GET /api/generate/status/:videoId
Authorization: Bearer <token>
```

### ç”¨æˆ·æ¥å£

#### æ¯æ—¥ç­¾åˆ°
```
POST /api/user/signin
Authorization: Bearer <token>
```

#### è·å–ç”¨æˆ·ç»Ÿè®¡
```
GET /api/user/stats
Authorization: Bearer <token>
```

### æ”¯ä»˜æ¥å£

#### è·å–è®¢é˜…è®¡åˆ’
```
GET /api/payment/plans
```

#### åˆ›å»ºæ”¯ä»˜é“¾æ¥
```
POST /api/payment/create-payment
Authorization: Bearer <token>
Content-Type: application/json

{
  "type": "subscription",
  "plan_id": "plus",
  "amount": 9.99,
  "currency": "USD"
}
```

### æç¤ºè¯æ¥å£

#### è·å–çƒ­é—¨æç¤ºè¯
```
GET /api/prompt/hot?limit=5
```

#### æœç´¢æç¤ºè¯
```
GET /api/prompt/search?q=sunset&category=nature
```

## è®¢é˜…ç­‰çº§

| ç­‰çº§ | æ¯æœˆç”Ÿæˆæ¬¡æ•° | æœ€å¤§æ—¶é•¿ | æ”¯æŒæ¨¡å‹ | æ‰¹é‡ç”Ÿæˆ | èµ é€ç§¯åˆ† | ä»·æ ¼ |
|------|-------------|----------|----------|----------|----------|------|
| å…è´¹ç‰ˆ | 3æ¬¡ | 5ç§’ | WAN I2V (480p) | 1ä¸ª | 30ç§¯åˆ† | å…è´¹ |
| Plusç‰ˆ | æ— é™ | 5ç§’ | WAN I2V + T2V (720p) | 1ä¸ª | 120ç§¯åˆ† | $12.99/æœˆ (å¹´ä»˜$9.99/æœˆ) |
| Proç‰ˆ | æ— é™ | 5-10ç§’ | WAN I2V + T2V (720p) | 4ä¸ª | 380ç§¯åˆ† | $36.99/æœˆ (å¹´ä»˜$29.99/æœˆ) |
| æ——èˆ°ç‰ˆ | æ— é™ | 5-10ç§’ | å…¨æ¨¡å‹ (1080p) | 4ä¸ª | 1000ç§¯åˆ† | $99.99/æœˆ (å¹´ä»˜$69.99/æœˆ) |

## ç§¯åˆ†æ¶ˆè€—

| ç”Ÿæˆç±»å‹ | 5ç§’è§†é¢‘ | 10ç§’è§†é¢‘ | æˆæœ¬å‚è€ƒ |
|----------|---------|----------|----------|
| WAN I2V (480p) | 22ç§¯åˆ† | 32ç§¯åˆ† | æ¯ç§’$0.09 |
| WAN T2V (720p) | 45ç§¯åˆ† | 65ç§¯åˆ† | æ¯ç§’$0.24 |
| Google Veo-3 (1080p) | 70ç§¯åˆ† | 140ç§¯åˆ† | æ¯ç§’$0.75 |

## ç§¯åˆ†å……å€¼åŒ…

| ç§¯åˆ†åŒ… | ä»·æ ¼ | èµ é€ç§¯åˆ† | æ€§ä»·æ¯” |
|--------|------|----------|--------|
| 100ç§¯åˆ† | $9.99 | +10ç§¯åˆ† | åŸºç¡€åŒ… |
| 250ç§¯åˆ† | $22.99 | +25ç§¯åˆ† | è¿›é˜¶åŒ… |
| 500ç§¯åˆ† | $44.99 | +50ç§¯åˆ† | é«˜çº§åŒ… â­ |
| 1000ç§¯åˆ† | $79.99 | æ— èµ é€ | è¶…å€¼åŒ… |

## ç­¾åˆ°ç³»ç»Ÿ

- **æ¯æ—¥ç­¾åˆ°**: 2ç§¯åˆ†
- **è¿ç»­7å¤©**: é¢å¤–5ç§¯åˆ†å¥–åŠ±
- **æœˆç­¾25å¤©**: é¢å¤–12ç§¯åˆ†å¥–åŠ±
- **æ¯æœˆé‡ç½®**: ä¸å¯è¡¥ç­¾

## å®šæ—¶ä»»åŠ¡

- **æ¯å¤© 0:00**: æ›´æ–°çƒ­é—¨æç¤ºè¯ç»Ÿè®¡
- **æ¯å¤© 1:00**: æ¸…ç†è¿‡æœŸè®¢é˜…
- **æ¯å°æ—¶**: æ£€æŸ¥å¤±è´¥çš„è§†é¢‘ç”Ÿæˆä»»åŠ¡

## éƒ¨ç½²è¯´æ˜

### Docker éƒ¨ç½²

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

### ç¯å¢ƒè¦æ±‚

- Node.js 18+
- MongoDB 5.0+
- å†…å­˜: è‡³å°‘ 512MB
- å­˜å‚¨: è‡³å°‘ 1GB

## ç›‘æ§å’Œæ—¥å¿—

- å¥åº·æ£€æŸ¥ç«¯ç‚¹: `GET /health`
- é”™è¯¯æ—¥å¿—è‡ªåŠ¨è®°å½•
- è¯·æ±‚é€Ÿç‡é™åˆ¶
- å®‰å…¨å¤´éƒ¨è®¾ç½®

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»º Pull Request

## è®¸å¯è¯

MIT License

## è”ç³»æ–¹å¼

## æ”¯ä»˜ç³»ç»Ÿè¯¦æƒ…

### è®¢é˜…ç­‰çº§å¯¹æ¯”

| ç­‰çº§ | æœˆè´¹ | å¹´è´¹ | ç”Ÿæˆæ¬¡æ•° | è§†é¢‘æ—¶é•¿ | ç”»è´¨ | æ”¯æŒæ¨¡å‹ | æ‰¹é‡ç”Ÿæˆ | ç§¯åˆ†å¥–åŠ± |
|------|------|------|----------|----------|------|----------|----------|----------|
| å…è´¹ç‰ˆ | $0 | - | 3æ¬¡/æœˆ | 5ç§’ | 480P | WAN I2V | 1ä¸ª | 30 |
| Plusç‰ˆ | $12.99 | $9.99 | æ— é™ | 5ç§’ | 720P | WAN I2V + T2V | 1ä¸ª | 120/1440 |
| Proç‰ˆ | $36.99 | $29.99 | æ— é™ | 5-10ç§’ | 720P | WAN I2V + T2V | 4ä¸ª | 380/4560 |
| æ——èˆ°ç‰ˆ | $99.99 | $69.99 | æ— é™ | 5-10ç§’ | 1080P | å…¨æ¨¡å‹ | 4ä¸ª | 1000/12000 |

### ç§¯åˆ†æ¶ˆè€—

| æ¨¡å‹ | ç”»è´¨ | 5ç§’è§†é¢‘ | 10ç§’è§†é¢‘ |
|------|------|---------|----------|
| WAN I2V | 480p | 5ç§¯åˆ† | 9ç§¯åˆ† |
| WAN T2V | 720p | 12ç§¯åˆ† | 24ç§¯åˆ† |
| Google Veo-3 | 1080p | 38ç§¯åˆ† | 75ç§¯åˆ† |

### æ”¯ä»˜API

å®Œæ•´çš„æ”¯ä»˜APIæ–‡æ¡£è¯·å‚è€ƒ [PAYMENT_API.md](./PAYMENT_API.md)

ä¸»è¦APIç«¯ç‚¹ï¼š
- `POST /api/payment/create-subscription` - åˆ›å»ºè®¢é˜…æ”¯ä»˜
- `POST /api/payment/create-points-payment` - åˆ›å»ºç§¯åˆ†å……å€¼
- `GET /api/payment/subscription-status` - è·å–è®¢é˜…çŠ¶æ€
- `POST /api/payment/cancel-subscription` - å–æ¶ˆè®¢é˜…

### Webhook é…ç½®

åœ¨ Creem æ§åˆ¶å°é…ç½®ä»¥ä¸‹ Webhook URLï¼š
```
https://lbszbktvnuvn.sealoshzh.site/api/payment/webhook
```

---

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚ 